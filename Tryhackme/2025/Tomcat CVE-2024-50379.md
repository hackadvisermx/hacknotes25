#TOCTOU
# Tomcat: CVE-2024-50379

Apache Tomcat is an open-source web server and servlet container. If you are unfamiliar with the term, a **servlet** is a Java class created to run on an application server and handle client requests. It receives the client’s HTTP request, processes it, and generates the proper response. A **servlet container** provides the runtime environment for the Java servlets and manages their lifecycle.

This room is dedicated to a recent Tomcat vulnerability, [CVE-2024-50379](https://nvd.nist.gov/vuln/detail/CVE-2024-50379), that impacts the following versions of Apache Tomcat:

- Apache Tomcat 11.0.0-M1 to 11.0.1 (Fixed in 11.0.2 or later)
- Apache Tomcat 10.1.0-M1 to 10.1.33 (Fixed in 10.1.34 or later)
- Apache Tomcat 9.0.0.M1 to 9.0.97 (Fixed in 9.0.98 or later)

The CVE-2024-50379 is an example of a Time-of-check Time-of-use (TOCTOU) vulnerability. A TOCTOU vulnerability arises from a race condition between checking a resource and using it. In other words, after a system checks the state of a resource and before using it, the resource changes, and the system ends using the changed resource. In this vulnerability, the TOCTOU race condition arises during the JSP (Java Server Page) compilation on case-insensitive systems, provided the default servlet has write permissions.

## Learning Objectives

In this room, we will cover the following:

- What’s a TOCTOU and how it can be exploited
- Exploiting a vulnerable version of Tomcat
- Detecting such an exploitation
- Securing your installation


# Technical Background

You might be asking how TOCTOU applies in this case. Before elaborating on this, we should mention that there are two main conditions for the vulnerability to be exploited on vulnerable servers:

First and foremost, the server allows users to upload and delete files, i.e., the server is configured to accept HTTP commands such as PUT and DELETE. Writing is enabled by setting `readonly` to `false` in the `web.xml` configuration file. Note that the default configuration is readonly.

```xml
<init-param>
  <param-name>readonly</param-name>
  <param-value>false</param-value>
</init-param>
```

Below is an example of an insecure configuration in which the application server is set to allow writing by default.

```xml
<servlet>
  <servlet-name>default</servlet-name>
  <servlet-class>org.apache.catalina.servlets.DefaultServlet</servlet-class>
  <init-param>
    <param-name>debug</param-name>
    <param-value>0</param-value>
  </init-param>
  <init-param>
    <param-name>listings</param-name>
    <param-value>false</param-value>
  </init-param>
  <init-param>
    <param-name>readonly</param-name>
    <param-value>false</param-value>
  </init-param>
  <load-on-startup>1</load-on-startup>
</servlet>
```

The second condition for exploiting this vulnerability is for Tomcat to run on a case-insensitive system, such as MS Windows or macOS. When these two conditions are satisfied, exploiting this vulnerability is a matter of racing with the OS.

On case-sensitive systems like Linux, `demo.jsp` and `demo.Jsp` are two different files. Consequently, on a Linux system, it is not impossible to see `documents` and `Documents` coexisting in the same directory.

Because the MS Windows system is case-insensitive, `demo.jsp` and `demo.Jsp` cannot be two different files; however, for Tomcat, the former is a servlet that can be executed, while the latter is treated as a text file. In other words, MS Windows would treat `demo.Jsp` no different than it would treat a servlet properly named `demo.jsp`; it is Tomcat’s case sensitivity checking that will stop `demo.Jsp` from getting executed and prevent treating it as an executable file.

Click the **Start AttackBox** button at the top of the page and wait for it to load. Furthermore, click on the **Start Machine** button below to get your target system ready. Please allow 5 minutes for the target system to properly boot up. Once both systems are ready, open the terminal on the AttackBox to follow along.


If we try to create the file `demo.jsp`, for example, using `curl -X PUT -d "test" http://MACHINE_IP:8080/demo.jsp`  will produce an error. This error is expected as servlets can execute commands on the server side; therefore, allowing users to upload `.jsp` files gives them remote code execution (RCE) ability. In the terminal below, we see an example error.

AttackBox Terminal

```shell-session
root@tryhackme:~# curl -X PUT -d "test" http://MACHINE_IP:8080/demo.jsp
<!doctype html><html lang="en"><head><title>HTTP Status 404 – Not Found</title><style type="text/css">body {font-family:Tahoma,Arial,sans-serif;} h1, h2, h3, b {color:white;background-color:#525D76;} h1 {font-size:22px;} h2 {font-size:16px;} h3 {font-size:14px;} p {font-size:12px;} a {color:black;} .line {height:1px;background-color:#525D76;border:none;}</style></head><body><h1>HTTP Status 404 – Not Found</h1><hr class="line" /><p><b>Type</b> Status Report</p><p><b>Message</b> JSP file [&#47;demo.jsp] not found</p><p><b>Description</b> The origin server did not find a current representation for the target resource or is not willing to disclose that one exists.</p><hr class="line" /><h3>Apache Tomcat/10.1.30</h3></body></html>
```

Let’s create a file with the extension `Jsp` or `JSP`. This step should work successfully, as Tomcat does not see such extensions as executable. We can see that the `demo.Jsp` file was successfully created on the server.

AttackBox Terminal

```shell-session
root@tryhackme:~# curl -X PUT -d "test" http://MACHINE_IP:8080/demo.Jsp
root@tryhackme:~# curl http://MACHINE_IP:8080/demo.Jsp
test
```

If we try to access `demo.Jsp`, a case-insensitive system will see it no different than `demo.jsp`, but Tomcat case sensitivity will inspect the extension and treat it as a text file instead. It is shown that when the server is under heavy load, a race condition becomes possible. The `demo.Jsp` might get compiled and executed as a servlet. Because it is a case-insensitive system, enforcing the constraints on the servlet extension, such as `Jsp` and `JSP`, has shifted from the OS to the application server. In other words, when a system is under load, and there is a concurrent read and write of the same file, the case sensitivity checks might get bypassed, resulting in the uploaded file getting executed as a servlet.